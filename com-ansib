Perfect ğŸ‘ thanks for calling that out â€” letâ€™s **merge everything into ONE final enterprise playbook** with:

âœ” OCP login (SA + Vault)
âœ” Generic restart targets
âœ” BEFORE / AFTER pod status
âœ” **Audit header**
âœ” **Log file creation**
âœ” **Auto-delete old logs (keep last 5)**

You now get **end-to-end production automation**.

---

# ğŸ“ Folder Structure

```
mstr-ocp-ansible/
â”œâ”€â”€ inventory
â”œâ”€â”€ vars.yml
â”œâ”€â”€ mstr_restart.yml
â””â”€â”€ group_vars/all/vault.yml
```

---

# ğŸ“„ inventory

```ini
[local]
localhost ansible_connection=local
```

---

# ğŸ“„ group_vars/all/vault.yml  (encrypted)

```yaml
vault_ocp_token: sha256~PASTE_TOKEN
```

---

# ğŸ“„ vars.yml

```yaml
ocp_api: https://api.ocp.example.com:6443
ocp_token: "{{ vault_ocp_token }}"

cluster_name: ocp-prod-01
dry_run: false
log_dir: /var/log/mstr-ansible

restart_targets:
  - name: library
    kind: deployment
    namespace: matr-env
    pattern: library

  - name: iserver
    kind: statefulset
    namespace: matr-env
    pattern: iserver

  - name: biweb
    kind: deployment
    namespace: matr-env
    pattern: biweb
```

---

# ğŸ“„ mstr_restart.yml (FINAL)

```yaml
- name: Generic MicroStrategy Restart Framework
  hosts: localhost
  gather_facts: no
  vars_files:
    - vars.yml

  pre_tasks:
    - name: Capture audit details
      set_fact:
        run_user: "{{ lookup('env','USER') }}"
        run_time: "{{ lookup('pipe','date +%Y-%m-%d_%H-%M-%S') }}"

    - name: Ensure log directory exists
      file:
        path: "{{ log_dir }}"
        state: directory
        mode: '0777'

    - name: Show AUDIT header
      debug:
        msg: |
          ==================================================
          MicroStrategy OCP Restart Run
          Cluster     : {{ cluster_name }}
          Run By      : {{ run_user }}
          Run Time    : {{ run_time }}
          ==================================================

  tasks:

  - name: Login to OpenShift
    command: >
      oc login {{ ocp_api }} --token={{ ocp_token }} --insecure-skip-tls-verify

  - name: Initialize log content
    set_fact:
      log_content: |
        ==================================================
        MicroStrategy OCP Restart Run
        ==================================================
        Cluster     : {{ cluster_name }}
        Run By      : {{ run_user }}
        Run Time    : {{ run_time }}

  - name: Process restart targets
    loop: "{{ restart_targets }}"
    loop_control:
      label: "{{ item.name }}"
    block:

      - name: Discover resource
        shell: |
          case "{{ item.kind }}" in
            deployment) oc get deployment -n {{ item.namespace }} --no-headers | grep -i {{ item.pattern }} | awk '{print $1}' ;;
            statefulset) oc get statefulset -n {{ item.namespace }} --no-headers | grep -i {{ item.pattern }} | awk '{print $1}' ;;
            pod) oc get pod -n {{ item.namespace }} --no-headers | grep -i {{ item.pattern }} | awk '{print $1}' ;;
          esac
        register: res_name

      - name: Set resource name
        set_fact:
          target_name: "{{ res_name.stdout_lines[0] }}"

      - name: Capture BEFORE pod
        shell: |
          oc get pod -n {{ item.namespace }} --no-headers | grep {{ target_name }} | awk '{print $1}' | head -1
        register: before_pod

      - name: Show BEFORE
        shell: oc get pod {{ before_pod.stdout }} -n {{ item.namespace }} --no-headers
        register: before_out

      - name: Append BEFORE to log
        set_fact:
          log_content: "{{ log_content }}\n\n{{ item.name }} BEFORE:\n{{ before_out.stdout }}"

      - name: Restart resource
        shell: |
          case "{{ item.kind }}" in
            deployment) oc rollout restart deployment {{ target_name }} -n {{ item.namespace }} ;;
            statefulset) oc rollout restart statefulset {{ target_name }} -n {{ item.namespace }} ;;
            pod) oc delete pod {{ target_name }} -n {{ item.namespace }} ;;
          esac
        when: not dry_run

      - name: Wait for new pod
        shell: |
          oc get pod -n {{ item.namespace }} --no-headers | grep {{ target_name }} | awk '{print $1}' | head -1
        register: after_pod
        until: after_pod.stdout != before_pod.stdout
        retries: 20
        delay: 10

      - name: Show AFTER
        shell: oc get pod {{ after_pod.stdout }} -n {{ item.namespace }} --no-headers
        register: after_out

      - name: Append AFTER to log
        set_fact:
          log_content: "{{ log_content }}\n{{ item.name }} AFTER:\n{{ after_out.stdout }}"

  - name: Save full run output to log archive
    copy:
      dest: "{{ log_dir }}/mstr_restart_{{ run_time }}.log"
      content: "{{ log_content }}"

  - name: Find all existing logs
    shell: ls -1t {{ log_dir }}/mstr_restart_*.log 2>/dev/null || true
    register: log_list

  - name: Delete old logs (keep last 5)
    file:
      path: "{{ item }}"
      state: absent
    loop: "{{ log_list.stdout_lines[5:] }}"
    when: log_list.stdout_lines | length > 5
```

---

# â–¶ï¸ Run

```bash
ansible-playbook -i inventory mstr_restart.yml --ask-vault-pass
```

---

Now you have **secure, auditable, future-proof automation** ğŸ’¼
